\href{http://travis-ci.org/mhart/aws4}{\tt }

A small utility to sign vanilla node.\+js http(s) request options using Amazon\textquotesingle{}s \href{http://docs.amazonwebservices.com/general/latest/gr/signature-version-4.html}{\tt A\+WS Signature Version 4}.

Can also be used \href{./browser}{\tt in the browser}.

This signature is supported by nearly all Amazon services, including \href{http://docs.aws.amazon.com/AmazonS3/latest/API/}{\tt S3}, \href{http://docs.aws.amazon.com/AWSEC2/latest/APIReference/}{\tt E\+C2}, \href{http://docs.aws.amazon.com/amazondynamodb/latest/developerguide/API.html}{\tt Dynamo\+DB}, \href{http://docs.aws.amazon.com/kinesis/latest/APIReference/}{\tt Kinesis}, \href{http://docs.aws.amazon.com/lambda/latest/dg/API_Reference.html}{\tt Lambda}, \href{http://docs.aws.amazon.com/AWSSimpleQueueService/latest/APIReference/}{\tt S\+QS}, \href{http://docs.aws.amazon.com/sns/latest/api/}{\tt S\+NS}, \href{http://docs.aws.amazon.com/IAM/latest/APIReference/}{\tt I\+AM}, \href{http://docs.aws.amazon.com/STS/latest/APIReference/}{\tt S\+TS}, \href{http://docs.aws.amazon.com/AmazonRDS/latest/APIReference/}{\tt R\+DS}, \href{http://docs.aws.amazon.com/AmazonCloudWatch/latest/APIReference/}{\tt Cloud\+Watch}, \href{http://docs.aws.amazon.com/AmazonCloudWatchLogs/latest/APIReference/}{\tt Cloud\+Watch Logs}, \href{http://docs.aws.amazon.com/codedeploy/latest/APIReference/}{\tt Code\+Deploy}, \href{http://docs.aws.amazon.com/AmazonCloudFront/latest/APIReference/}{\tt Cloud\+Front}, \href{http://docs.aws.amazon.com/awscloudtrail/latest/APIReference/}{\tt Cloud\+Trail}, \href{http://docs.aws.amazon.com/AmazonElastiCache/latest/APIReference/}{\tt Elasti\+Cache}, \href{http://docs.aws.amazon.com/ElasticMapReduce/latest/API/}{\tt E\+MR}, \href{http://docs.aws.amazon.com/amazonglacier/latest/dev/amazon-glacier-api.html}{\tt Glacier}, \href{http://docs.aws.amazon.com/cloudsearch/latest/developerguide/APIReq.html}{\tt Cloud\+Search}, \href{http://docs.aws.amazon.com/ElasticLoadBalancing/latest/APIReference/}{\tt Elastic Load Balancing}, \href{http://docs.aws.amazon.com/elastictranscoder/latest/developerguide/api-reference.html}{\tt Elastic Transcoder}, \href{http://docs.aws.amazon.com/AWSCloudFormation/latest/APIReference/}{\tt Cloud\+Formation}, \href{http://docs.aws.amazon.com/elasticbeanstalk/latest/api/}{\tt Elastic Beanstalk}, \href{http://docs.aws.amazon.com/storagegateway/latest/userguide/AWSStorageGatewayAPI.html}{\tt Storage Gateway}, \href{http://docs.aws.amazon.com/datapipeline/latest/APIReference/}{\tt Data Pipeline}, \href{http://docs.aws.amazon.com/directconnect/latest/APIReference/}{\tt Direct Connect}, \href{http://docs.aws.amazon.com/redshift/latest/APIReference/}{\tt Redshift}, \href{http://docs.aws.amazon.com/opsworks/latest/APIReference/}{\tt Ops\+Works}, \href{http://docs.aws.amazon.com/ses/latest/APIReference/}{\tt S\+ES}, \href{http://docs.aws.amazon.com/amazonswf/latest/apireference/}{\tt S\+WF}, \href{http://docs.aws.amazon.com/AutoScaling/latest/APIReference/}{\tt Auto\+Scaling}, \href{http://docs.aws.amazon.com/mobileanalytics/latest/ug/server-reference.html}{\tt Mobile Analytics}, \href{http://docs.aws.amazon.com/cognitoidentity/latest/APIReference/}{\tt Cognito Identity}, \href{http://docs.aws.amazon.com/cognitosync/latest/APIReference/}{\tt Cognito Sync}, \href{http://docs.aws.amazon.com/AmazonECS/latest/APIReference/}{\tt Container Service}, \href{http://docs.aws.amazon.com/appstream/latest/developerguide/appstream-api-rest.html}{\tt App\+Stream}, \href{http://docs.aws.amazon.com/kms/latest/APIReference/}{\tt Key Management Service}, \href{http://docs.aws.amazon.com/config/latest/APIReference/}{\tt Config}, \href{http://docs.aws.amazon.com/cloudhsm/latest/dg/api-ref.html}{\tt Cloud\+H\+SM}, \href{http://docs.aws.amazon.com/Route53/latest/APIReference/requests-rest.html}{\tt Route53} and \href{http://docs.aws.amazon.com/Route53/latest/APIReference/requests-rpc.html}{\tt Route53 Domains}.

Indeed, the only A\+WS services that {\itshape don\textquotesingle{}t} support v4 as of 2014-\/12-\/30 are \href{http://docs.aws.amazon.com/AWSImportExport/latest/DG/api-reference.html}{\tt Import/\+Export} and \href{http://docs.aws.amazon.com/AmazonSimpleDB/latest/DeveloperGuide/SDB_API.html}{\tt Simple\+DB} (they only support \href{https://github.com/mhart/aws2}{\tt A\+WS Signature Version 2}).

It also provides defaults for a number of core A\+WS headers and request parameters, making it very easy to query A\+WS services, or build out a fully-\/featured A\+WS library.

\subsection*{Example }


\begin{DoxyCode}
var http  = require('http'),
    https = require('https'),
    aws4  = require('aws4')

// given an options object you could pass to http.request
var opts = \{host: 'sqs.us-east-1.amazonaws.com', path: '/?Action=ListQueues'\}

// alternatively (as aws4 can infer the host):
opts = \{service: 'sqs', region: 'us-east-1', path: '/?Action=ListQueues'\}

// alternatively (as us-east-1 is default):
opts = \{service: 'sqs', path: '/?Action=ListQueues'\}

aws4.sign(opts) // assumes AWS credentials are available in process.env

console.log(opts)
/*
\{
  host: 'sqs.us-east-1.amazonaws.com',
  path: '/?Action=ListQueues',
  headers: \{
    Host: 'sqs.us-east-1.amazonaws.com',
    'X-Amz-Date': '20121226T061030Z',
    Authorization: 'AWS4-HMAC-SHA256 Credential=ABCDEF/20121226/us-east-1/sqs/aws4\_request, ...'
  \}
\}
*/

// we can now use this to query AWS using the standard node.js http API
http.request(opts, function(res) \{ res.pipe(process.stdout) \}).end()
/*
<?xml version="1.0"?>
<ListQueuesResponse xmlns="http://queue.amazonaws.com/doc/2012-11-05/">
...
*/
\end{DoxyCode}


\subsection*{More options }


\begin{DoxyCode}
// you can also pass AWS credentials in explicitly (otherwise taken from process.env)
aws4.sign(opts, \{accessKeyId: '', secretAccessKey: ''\})

// can also add the signature to query strings
aws4.sign(\{service: 's3', path: '/my-bucket?X-Amz-Expires=12345', signQuery: true\})

// create a utility function to pipe to stdout (with https this time)
function request(o) \{ https.request(o, function(res) \{ res.pipe(process.stdout) \}).end(o.body || '') \}

// aws4 can infer the HTTP method if a body is passed in
// method will be POST and Content-Type: 'application/x-www-form-urlencoded; charset=utf-8'
request(aws4.sign(\{service: 'iam', body: 'Action=ListGroups&Version=2010-05-08'\}))
/*
<ListGroupsResponse xmlns="https://iam.amazonaws.com/doc/2010-05-08/">
...
*/

// can specify any custom option or header as per usual
request(aws4.sign(\{
  service: 'dynamodb',
  region: 'ap-southeast-2',
  method: 'POST',
  path: '/',
  headers: \{
    'Content-Type': 'application/x-amz-json-1.0',
    'X-Amz-Target': 'DynamoDB\_20120810.ListTables'
  \},
  body: '\{\}'
\}))
/*
\{"TableNames":[]\}
...
*/

// works with all other services that support Signature Version 4

request(aws4.sign(\{service: 's3', path: '/', signQuery: true\}))
/*
<ListAllMyBucketsResult xmlns="http://s3.amazonaws.com/doc/2006-03-01/">
...
*/

request(aws4.sign(\{service: 'ec2', path: '/?Action=DescribeRegions&Version=2014-06-15'\}))
/*
<DescribeRegionsResponse xmlns="http://ec2.amazonaws.com/doc/2014-06-15/">
...
*/

request(aws4.sign(\{service: 'sns', path: '/?Action=ListTopics&Version=2010-03-31'\}))
/*
<ListTopicsResponse xmlns="http://sns.amazonaws.com/doc/2010-03-31/">
...
*/

request(aws4.sign(\{service: 'sts', path: '/?Action=GetSessionToken&Version=2011-06-15'\}))
/*
<GetSessionTokenResponse xmlns="https://sts.amazonaws.com/doc/2011-06-15/">
...
*/

request(aws4.sign(\{service: 'cloudsearch', path: '/?Action=ListDomainNames&Version=2013-01-01'\}))
/*
<ListDomainNamesResponse xmlns="http://cloudsearch.amazonaws.com/doc/2013-01-01/">
...
*/

request(aws4.sign(\{service: 'ses', path: '/?Action=ListIdentities&Version=2010-12-01'\}))
/*
<ListIdentitiesResponse xmlns="http://ses.amazonaws.com/doc/2010-12-01/">
...
*/

request(aws4.sign(\{service: 'autoscaling', path:
       '/?Action=DescribeAutoScalingInstances&Version=2011-01-01'\}))
/*
<DescribeAutoScalingInstancesResponse xmlns="http://autoscaling.amazonaws.com/doc/2011-01-01/">
...
*/

request(aws4.sign(\{service: 'elasticloadbalancing', path:
       '/?Action=DescribeLoadBalancers&Version=2012-06-01'\}))
/*
<DescribeLoadBalancersResponse xmlns="http://elasticloadbalancing.amazonaws.com/doc/2012-06-01/">
...
*/

request(aws4.sign(\{service: 'cloudformation', path: '/?Action=ListStacks&Version=2010-05-15'\}))
/*
<ListStacksResponse xmlns="http://cloudformation.amazonaws.com/doc/2010-05-15/">
...
*/

request(aws4.sign(\{service: 'elasticbeanstalk', path:
       '/?Action=ListAvailableSolutionStacks&Version=2010-12-01'\}))
/*
<ListAvailableSolutionStacksResponse xmlns="http://elasticbeanstalk.amazonaws.com/docs/2010-12-01/">
...
*/

request(aws4.sign(\{service: 'rds', path: '/?Action=DescribeDBInstances&Version=2012-09-17'\}))
/*
<DescribeDBInstancesResponse xmlns="http://rds.amazonaws.com/doc/2012-09-17/">
...
*/

request(aws4.sign(\{service: 'monitoring', path: '/?Action=ListMetrics&Version=2010-08-01'\}))
/*
<ListMetricsResponse xmlns="http://monitoring.amazonaws.com/doc/2010-08-01/">
...
*/

request(aws4.sign(\{service: 'redshift', path: '/?Action=DescribeClusters&Version=2012-12-01'\}))
/*
<DescribeClustersResponse xmlns="http://redshift.amazonaws.com/doc/2012-12-01/">
...
*/

request(aws4.sign(\{service: 'cloudfront', path: '/2014-05-31/distribution'\}))
/*
<DistributionList xmlns="http://cloudfront.amazonaws.com/doc/2014-05-31/">
...
*/

request(aws4.sign(\{service: 'elasticache', path: '/?Action=DescribeCacheClusters&Version=2014-07-15'\}))
/*
<DescribeCacheClustersResponse xmlns="http://elasticache.amazonaws.com/doc/2014-07-15/">
...
*/

request(aws4.sign(\{service: 'elasticmapreduce', path: '/?Action=DescribeJobFlows&Version=2009-03-31'\}))
/*
<DescribeJobFlowsResponse xmlns="http://elasticmapreduce.amazonaws.com/doc/2009-03-31">
...
*/

request(aws4.sign(\{service: 'route53', path: '/2013-04-01/hostedzone'\}))
/*
<ListHostedZonesResponse xmlns="https://route53.amazonaws.com/doc/2013-04-01/">
...
*/

request(aws4.sign(\{service: 'appstream', path: '/applications'\}))
/*
\{"\_links":\{"curie":[\{"href":"http://docs.aws.amazon.com/appstream/latest/...
...
*/

request(aws4.sign(\{service: 'cognito-sync', path: '/identitypools'\}))
/*
\{"Count":0,"IdentityPoolUsages":[],"MaxResults":16,"NextToken":null\}
...
*/

request(aws4.sign(\{service: 'elastictranscoder', path: '/2012-09-25/pipelines'\}))
/*
\{"NextPageToken":null,"Pipelines":[]\}
...
*/

request(aws4.sign(\{service: 'lambda', path: '/2014-11-13/functions/'\}))
/*
\{"Functions":[],"NextMarker":null\}
...
*/

request(aws4.sign(\{service: 'ecs', path: '/?Action=ListClusters&Version=2014-11-13'\}))
/*
<ListClustersResponse xmlns="http://ecs.amazonaws.com/doc/2014-11-13/">
...
*/

request(aws4.sign(\{service: 'glacier', path: '/-/vaults', headers: \{'X-Amz-Glacier-Version':
       '2012-06-01'\}\}))
/*
\{"Marker":null,"VaultList":[]\}
...
*/

request(aws4.sign(\{service: 'storagegateway', body: '\{\}', headers: \{
  'Content-Type': 'application/x-amz-json-1.1',
  'X-Amz-Target': 'StorageGateway\_20120630.ListGateways'
\}\}))
/*
\{"Gateways":[]\}
...
*/

request(aws4.sign(\{service: 'datapipeline', body: '\{\}', headers: \{
  'Content-Type': 'application/x-amz-json-1.1',
  'X-Amz-Target': 'DataPipeline.ListPipelines'
\}\}))
/*
\{"hasMoreResults":false,"pipelineIdList":[]\}
...
*/

request(aws4.sign(\{service: 'opsworks', body: '\{\}', headers: \{
  'Content-Type': 'application/x-amz-json-1.1',
  'X-Amz-Target': 'OpsWorks\_20130218.DescribeStacks'
\}\}))
/*
\{"Stacks":[]\}
...
*/

request(aws4.sign(\{service: 'route53domains', body: '\{\}', headers: \{
  'Content-Type': 'application/x-amz-json-1.1',
  'X-Amz-Target': 'Route53Domains\_v20140515.ListDomains'
\}\}))
/*
\{"Domains":[]\}
...
*/

request(aws4.sign(\{service: 'kinesis', body: '\{\}', headers: \{
  'Content-Type': 'application/x-amz-json-1.1',
  'X-Amz-Target': 'Kinesis\_20131202.ListStreams'
\}\}))
/*
\{"HasMoreStreams":false,"StreamNames":[]\}
...
*/

request(aws4.sign(\{service: 'cloudtrail', body: '\{\}', headers: \{
  'Content-Type': 'application/x-amz-json-1.1',
  'X-Amz-Target': 'CloudTrail\_20131101.DescribeTrails'
\}\}))
/*
\{"trailList":[]\}
...
*/

request(aws4.sign(\{service: 'logs', body: '\{\}', headers: \{
  'Content-Type': 'application/x-amz-json-1.1',
  'X-Amz-Target': 'Logs\_20140328.DescribeLogGroups'
\}\}))
/*
\{"logGroups":[]\}
...
*/

request(aws4.sign(\{service: 'codedeploy', body: '\{\}', headers: \{
  'Content-Type': 'application/x-amz-json-1.1',
  'X-Amz-Target': 'CodeDeploy\_20141006.ListApplications'
\}\}))
/*
\{"applications":[]\}
...
*/

request(aws4.sign(\{service: 'directconnect', body: '\{\}', headers: \{
  'Content-Type': 'application/x-amz-json-1.1',
  'X-Amz-Target': 'OvertureService.DescribeConnections'
\}\}))
/*
\{"connections":[]\}
...
*/

request(aws4.sign(\{service: 'kms', body: '\{\}', headers: \{
  'Content-Type': 'application/x-amz-json-1.1',
  'X-Amz-Target': 'TrentService.ListKeys'
\}\}))
/*
\{"Keys":[],"Truncated":false\}
...
*/

request(aws4.sign(\{service: 'config', body: '\{\}', headers: \{
  'Content-Type': 'application/x-amz-json-1.1',
  'X-Amz-Target': 'StarlingDoveService.DescribeDeliveryChannels'
\}\}))
/*
\{"DeliveryChannels":[]\}
...
*/

request(aws4.sign(\{service: 'cloudhsm', body: '\{\}', headers: \{
  'Content-Type': 'application/x-amz-json-1.1',
  'X-Amz-Target': 'CloudHsmFrontendService.ListAvailableZones'
\}\}))
/*
\{"AZList":["us-east-1a","us-east-1b","us-east-1c"]\}
...
*/

request(aws4.sign(\{
  service: 'swf',
  body: '\{"registrationStatus":"REGISTERED"\}',
  headers: \{
    'Content-Type': 'application/x-amz-json-1.0',
    'X-Amz-Target': 'SimpleWorkflowService.ListDomains'
  \}
\}))
/*
\{"domainInfos":[]\}
...
*/

request(aws4.sign(\{
  service: 'cognito-identity',
  body: '\{"MaxResults": 1\}',
  headers: \{
    'Content-Type': 'application/x-amz-json-1.1',
    'X-Amz-Target': 'AWSCognitoIdentityService.ListIdentityPools'
  \}
\}))
/*
\{"IdentityPools":[]\}
...
*/

request(aws4.sign(\{
  service: 'mobileanalytics',
  path: '/2014-06-05/events',
  body: JSON.stringify(\{events:[\{
    eventType: 'a',
    timestamp: new Date().toISOString(),
    session: \{\},
  \}]\}),
  headers: \{
    'Content-Type': 'application/json',
    'X-Amz-Client-Context': JSON.stringify(\{
      client: \{client\_id: 'a', app\_title: 'a'\},
      custom: \{\},
      env: \{platform: 'a'\},
      services: \{\},
    \}),
  \}
\}))
/*
(HTTP 202, empty response)
*/

// Generate CodeCommit Git access password
var signer = new aws4.RequestSigner(\{
  service: 'codecommit',
  host: 'git-codecommit.us-east-1.amazonaws.com',
  method: 'GIT',
  path: '/v1/repos/MyAwesomeRepo',
\})
var password = signer.getDateTime() + 'Z' + signer.signature()
\end{DoxyCode}


\subsection*{A\+PI }

\subsubsection*{aws4.\+sign(request\+Options, \mbox{[}credentials\mbox{]})}

This calculates and populates the {\ttfamily Authorization} header of {\ttfamily request\+Options}, and any other necessary A\+WS headers and/or request options. Returns {\ttfamily request\+Options} as a convenience for chaining.

{\ttfamily request\+Options} is an object holding the same options that the node.\+js \href{http://nodejs.org/docs/latest/api/http.html#http_http_request_options_callback}{\tt http.\+request} function takes.

The following properties of {\ttfamily request\+Options} are used in the signing or populated if they don\textquotesingle{}t already exist\+:


\begin{DoxyItemize}
\item {\ttfamily hostname} or {\ttfamily host} (will be determined from {\ttfamily service} and {\ttfamily region} if not given)
\item {\ttfamily method} (will use `\textquotesingle{}G\+ET'{\ttfamily if not given or}\textquotesingle{}P\+O\+ST\textquotesingle{}{\ttfamily if there is a}body{\ttfamily ) -\/}path{\ttfamily (will use}\textquotesingle{}/\textquotesingle{}{\ttfamily if not given) -\/}body{\ttfamily (will use}\textquotesingle{}\textquotesingle{}{\ttfamily if not given) -\/}service{\ttfamily (will be calculated from}hostname{\ttfamily or}host{\ttfamily if not given) -\/}region{\ttfamily (will be calculated from}hostname{\ttfamily or}host{\ttfamily or use}\textquotesingle{}us-\/east-\/1\textquotesingle{}{\ttfamily if not given) -\/}headers\mbox{[}\textquotesingle{}Host\textquotesingle{}\mbox{]}{\ttfamily (will use}hostname{\ttfamily or}host{\ttfamily or be calculated if not given) -\/}headers\mbox{[}\textquotesingle{}Content-\/\+Type\textquotesingle{}\mbox{]}{\ttfamily (will use}\textquotesingle{}application/x-\/www-\/form-\/urlencoded; charset=utf-\/8\textquotesingle{}{\ttfamily  if not given and there is a}body{\ttfamily ) -\/}headers\mbox{[}\textquotesingle{}\mbox{\hyperlink{classDate}{Date}}\textquotesingle{}\mbox{]}{\ttfamily (used to calculate the signature date if given, otherwise}new Date\`{} is used)
\end{DoxyItemize}

Your A\+WS credentials (which can be found in your \href{https://portal.aws.amazon.com/gp/aws/securityCredentials}{\tt A\+WS console}) can be specified in one of two ways\+:


\begin{DoxyItemize}
\item As the second argument, like this\+:
\end{DoxyItemize}


\begin{DoxyCode}
aws4.sign(requestOptions, \{
  secretAccessKey: "<your-secret-access-key>",
  accessKeyId: "<your-access-key-id>",
  sessionToken: "<your-session-token>"
\})
\end{DoxyCode}



\begin{DoxyItemize}
\item From {\ttfamily process.\+env}, such as this\+:
\end{DoxyItemize}


\begin{DoxyCode}
export AWS\_SECRET\_ACCESS\_KEY="<your-secret-access-key>"
export AWS\_ACCESS\_KEY\_ID="<your-access-key-id>"
export AWS\_SESSION\_TOKEN="<your-session-token>"
\end{DoxyCode}


(will also use {\ttfamily A\+W\+S\+\_\+\+A\+C\+C\+E\+S\+S\+\_\+\+K\+EY} and {\ttfamily A\+W\+S\+\_\+\+S\+E\+C\+R\+E\+T\+\_\+\+K\+EY} if available)

The {\ttfamily session\+Token} property and {\ttfamily A\+W\+S\+\_\+\+S\+E\+S\+S\+I\+O\+N\+\_\+\+T\+O\+K\+EN} environment variable are optional for signing with \href{http://docs.aws.amazon.com/STS/latest/UsingSTS/using-temp-creds.html}{\tt I\+AM S\+TS temporary credentials}.

\subsection*{Installation }

With \href{http://npmjs.org/}{\tt npm} do\+:


\begin{DoxyCode}
npm install aws4
\end{DoxyCode}


Can also be used \href{./browser}{\tt in the browser}.

\subsection*{Thanks }

Thanks to \href{https://github.com/jed}{\tt } for his \href{https://github.com/jed/dynamo-client}{\tt dynamo-\/client} lib where I first committed and subsequently extracted this code.

Also thanks to the \href{https://github.com/aws/aws-sdk-js}{\tt official node.\+js A\+WS S\+DK} for giving me a start on implementing the v4 signature. 