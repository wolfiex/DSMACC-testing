Modern Buffer A\+PI polyfill without footguns, working on Node.\+js from 0.\+8 to current.

\subsection*{How to use?}

First, port all {\ttfamily Buffer()} and {\ttfamily new Buffer()} calls to {\ttfamily Buffer.\+alloc()} and {\ttfamily Buffer.\+from()} A\+PI.

Then, to achieve compatibility with outdated Node.\+js versions ({\ttfamily $<$4.\+5.\+0} and 5.\+x {\ttfamily $<$5.\+9.\+0}), use `const Buffer = require(\textquotesingle{}safer-\/buffer').Buffer{\ttfamily in all files where you make calls to the new Buffer A\+PI. \+\_\+\+Use}var{\ttfamily instead of}const\`{} if you need that for your Node.\+js version range support.\+\_\+

Also, see the https\+://github.com/\+Ch\+A\+Lke\+R/safer-\/buffer/blob/master/\+Porting-\/\+Buffer.\+md \char`\"{}porting Buffer\char`\"{} guide.

\subsection*{Do I need it?}

Hopefully, not — dropping support for outdated Node.\+js versions should be fine nowdays, and that is the recommended path forward. You {\itshape do} need to port to the {\ttfamily Buffer.\+alloc()} and {\ttfamily Buffer.\+from()} though.

See the https\+://github.com/\+Ch\+A\+Lke\+R/safer-\/buffer/blob/master/\+Porting-\/\+Buffer.\+md \char`\"{}porting guide\char`\"{} for a better description.

\subsection*{Why not \href{https://npmjs.com/safe-buffer}{\tt safe-\/buffer}?}

{\itshape In short\+: while {\ttfamily safe-\/buffer} serves as a polyfill for the new A\+PI, it allows old A\+PI usage and itself contains footguns.}

{\ttfamily safe-\/buffer} could be used safely to get the new A\+PI while still keeping support for older Node.\+js versions (like this module), but while analyzing ecosystem usage of the old Buffer A\+PI I found out that {\ttfamily safe-\/buffer} is itself causing problems in some cases.

For example, consider the following snippet\+:


\begin{DoxyCode}
$ cat example.unsafe.js
console.log(Buffer(20))
$ ./node-v6.13.0-linux-x64/bin/node example.unsafe.js
<Buffer 0a 00 00 00 00 00 00 00 28 13 de 02 00 00 00 00 05 00 00 00>
$ standard example.unsafe.js
standard: Use JavaScript Standard Style (https://standardjs.com)
  /home/chalker/repo/safer-buffer/example.unsafe.js:2:13: 'Buffer()' was deprecated since v6. Use
       'Buffer.alloc()' or 'Buffer.from()' (use 'https://www.npmjs.com/package/safe-buffer' for '<4.5.0') instead.
\end{DoxyCode}


This is allocates and writes to console an uninitialized chunk of memory. \href{https://www.npmjs.com/package/standard}{\tt standard} linter (among others) catch that and warn people to avoid using unsafe A\+PI.

Let\textquotesingle{}s now throw in {\ttfamily safe-\/buffer}!


\begin{DoxyCode}
$ cat example.safe-buffer.js
const Buffer = require('safe-buffer').Buffer
console.log(Buffer(20))
$ standard example.safe-buffer.js
$ ./node-v6.13.0-linux-x64/bin/node example.safe-buffer.js
<Buffer 08 00 00 00 00 00 00 00 28 58 01 82 fe 7f 00 00 00 00 00 00>
\end{DoxyCode}


See the problem? Adding in {\ttfamily safe-\/buffer} {\itshape magically removes the lint warning}, but the behavior remains identiсal to what we had before, and when launched on Node.\+js 6.\+x L\+TS — this dumps out chunks of uninitialized memory. {\itshape And this code will still emit runtime warnings on Node.\+js 10.\+x and above.}

That was done by design. I first considered changing {\ttfamily safe-\/buffer}, prohibiting old A\+PI usage or emitting warnings on it, but that significantly diverges from {\ttfamily safe-\/buffer} design. After some discussion, it was decided to move my approach into a separate package, and {\itshape this is that separate package}.

This footgun is not imaginary — I observed top-\/downloaded packages doing that kind of thing, «fixing» the lint warning by blindly including {\ttfamily safe-\/buffer} without any actual changes.

Also in some cases, even if the A\+PI {\itshape was} migrated to use of safe Buffer A\+PI — a random pull request can bring unsafe Buffer A\+PI usage back to the codebase by adding new calls — and that could go unnoticed even if you have a linter prohibiting that (becase of the reason stated above), and even pass CI. {\itshape I also observed that being done in popular packages.}

Some examples\+:
\begin{DoxyItemize}
\item \href{https://github.com/webdriverio/webdriverio/commit/05cbd3167c12e4930f09ef7cf93b127ba4effae4#diff-124380949022817b90b622871837d56cR31}{\tt webdriverio} (a module with 548 759 downloads/month),
\item \href{https://github.com/maxogden/websocket-stream/commit/c9312bd24d08271687d76da0fe3c83493871cf61}{\tt websocket-\/stream} (218 288 d/m, fix in \href{https://github.com/maxogden/websocket-stream/pull/142}{\tt maxogden/websocket-\/stream\#142}),
\item \href{https://github.com/node-serialport/node-serialport/commit/e8d9d2b16c664224920ce1c895199b1ce2def48c}{\tt node-\/serialport} (113 138 d/m, fix in \href{https://github.com/node-serialport/node-serialport/pull/1510}{\tt node-\/serialport/node-\/serialport\#1510}),
\item \href{https://github.com/karma-runner/karma/commit/3d94b8cf18c695104ca195334dc75ff054c74eec}{\tt karma} (3 973 193 d/m, fix in \href{https://github.com/karma-runner/karma/pull/2947}{\tt karma-\/runner/karma\#2947}),
\item \href{https://github.com/spdy-http2/spdy-transport/commit/5375ac33f4a62a4f65bcfc2827447d42a5dbe8b1}{\tt spdy-\/transport} (5 970 727 d/m, fix in \href{https://github.com/spdy-http2/spdy-transport/pull/53}{\tt spdy-\/http2/spdy-\/transport\#53}).
\item And there are a lot more over the ecosystem.
\end{DoxyItemize}

I filed a PR at \href{https://github.com/mysticatea/eslint-plugin-node/pull/110}{\tt mysticatea/eslint-\/plugin-\/node\#110} to partially fix that (for cases when that lint rule is used), but it is a semver-\/major change for linter rules and presets, so it would take significant time for that to reach actual setups. {\itshape It also hasn\textquotesingle{}t been released yet (2018-\/03-\/20).}

Also, {\ttfamily safer-\/buffer} discourages the usage of {\ttfamily .alloc\+Unsafe()}, which is often done by a mistake. It still supports it with an explicit concern barier, by placing it under `require(\textquotesingle{}safer-\/buffer/dangereous')\`{}.

\subsection*{But isn\textquotesingle{}t throwing bad?}

Not really. It\textquotesingle{}s an error that could be noticed and fixed early, instead of causing havoc later like unguarded {\ttfamily new Buffer()} calls that end up receiving user input can do.

This package affects only the files where `var Buffer = require(\textquotesingle{}safer-\/buffer').Buffer\`{} was done, so it is really simple to keep track of things and make sure that you don\textquotesingle{}t mix old A\+PI usage with that. Also, CI should hint anything that you might have missed.

New commits, if tested, won\textquotesingle{}t land new usage of unsafe Buffer A\+PI this way. {\itshape Node.\+js 10.\+x also deals with that by printing a runtime depecation warning.}

\subsubsection*{Would it affect third-\/party modules?}

No, unless you explicitly do an awful thing like monkey-\/patching or overriding the built-\/in {\ttfamily Buffer}. Don\textquotesingle{}t do that.

\subsubsection*{But I don\textquotesingle{}t want throwing…}

That is also fine!

Also, it could be better in some cases when you don\textquotesingle{}t comprehensive enough test coverage.

In that case — just don\textquotesingle{}t override {\ttfamily Buffer} and use `var Safer\+Buffer = require(\textquotesingle{}safer-\/buffer').Buffer\`{} instead.

That way, everything using {\ttfamily Buffer} natively would still work, but there would be two drawbacks\+:


\begin{DoxyItemize}
\item {\ttfamily Buffer.\+from}/{\ttfamily Buffer.\+alloc} won\textquotesingle{}t be polyfilled — use {\ttfamily Safer\+Buffer.\+from} and {\ttfamily Safer\+Buffer.\+alloc} instead.
\item You are still open to accidentally using the insecure deprecated A\+PI — use a linter to catch that.
\end{DoxyItemize}

Note that using a linter to catch accidential {\ttfamily Buffer} constructor usage in this case is strongly recommended. {\ttfamily Buffer} is not overriden in this usecase, so linters won\textquotesingle{}t get confused.

\subsection*{«\+Without footguns»?}

Well, it is still possible to do {\itshape some} things with {\ttfamily Buffer} A\+PI, e.\+g. accessing {\ttfamily .buffer} property on older versions and duping things from there. You shouldn\textquotesingle{}t do that in your code, probabably.

The intention is to remove the most significant footguns that affect lots of packages in the ecosystem, and to do it in the proper way.

Also, this package doesn\textquotesingle{}t protect against security issues affecting some Node.\+js versions, so for usage in your own production code, it is still recommended to update to a Node.\+js version \href{https://github.com/nodejs/release#release-schedule}{\tt supported by upstream}. 