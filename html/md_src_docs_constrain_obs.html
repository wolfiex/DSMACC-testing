<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>DSMACC: Soft Constraining a Species Concentration to Observation.</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">DSMACC
   &#160;<span id="projectnumber">2019</span>
   </div>
   <div id="projectbrief">Changes to DSMACC for the thesis of Daniel Ellis</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

</div><!-- top -->
<div class="header">
  <div class="headertitle">
<div class="title">Soft Constraining a Species Concentration to Observation. </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h5>In this guide we shall approximate a diurnal equation using a</h5>
<p>function, and then include this in the constraints array of DSMACC</p>
<p>Note: the dim of the curve fit need to be adjusted, as does the pressision of the fitting. This will be done in future automatically, but until then this should serve as a guide. (high dim corresponds to more calculations,and thus a slower running model). As dims are by default, xlength-1, do not supply more than 10 day fraction values.</p>
<p>Program: Julia - although python or any other curve fitting program may be used.</p>
<h3>Firstly we need some observations</h3>
<p>To do this I shall use a HO2 diurnal taken from the Thesis of Peter M. Edwards - Tropospheric oxidation from the Tropics to the Poles, Leeds</p><ol type="1">
<li></li>
</ol>
<div class="image">
<img src="./img/HO2Diurnal.png" alt="alt text"/>
</div>
<p>I shall use readings every 0.1 fraction/day from the Black line. These are out trial concentrations for the method, so the actual values do not matter. <br />
</p>
<div class="fragment"><div class="line"># To get a fit for the observations I use Julia as it seems the easiest </div><div class="line">method</div><div class="line"># Include libraries (install with Pkg.add(&quot;libraryname&quot;))</div><div class="line">using Polynomials</div><div class="line">using UnicodePlots</div></div><!-- fragment --><div class="fragment"><div class="line">species = &quot;HO2&quot;</div><div class="line">observations = [8e-10,1e-9,1e-9,2e-9,8e-9,1.4e-8,1.3e-8,7e-9,1e-9,9e-10]</div><div class="line">hours  = linspace(0,1,length(observations)) #fract day </div><div class="line"></div><div class="line"></div><div class="line">#curve of observations</div><div class="line">#length = len(x) -1 - change this or do not use &gt; 10 observation points </div><div class="line">-&gt; smoothing</div><div class="line">fit = polyfit(hours,[log10(x) for x in observations])</div><div class="line">print(fit)</div><div class="line"></div><div class="line"></div><div class="line">#Since this will be run in a terminal we can use unicode plotting to </div><div class="line">check that we are not overfitting. </div><div class="line">xaxis = linspace(0,1,100)</div><div class="line">ypred = [(10^fit(x))/1e-8 for x in xaxis] #divided by 1e-8 to get rid of </div><div class="line">the log axis requirement as per original plot</div><div class="line"></div><div class="line"></div><div class="line">#plotting</div><div class="line">myplot = lineplot(xaxis,ypred, title = species, name = &quot;Prediction&quot;,  </div><div class="line">color=:blue,border=:bold)</div><div class="line">myplot = scatterplot!(myplot, hours, [i/1.e-8 for i in observations], </div><div class="line">name = &quot;Observations&quot;,color=:magenta)</div><div class="line"></div><div class="line">println(myplot)</div></div><!-- fragment --> <pre class="fragment">Poly(-9.136910012988708 - 19.043869223495985*x + 
</pre><p> 481.4511050554504*x^2 - 4471.672275544299*x^3 + 20929.295613210943*x^4 - 55026.76874840524*x^5 + 85141.43766292353*x^6 - 77002.83860070464*x^7 + 37641.488066733735*x^8 - 7673.297801523576*x^9)[1m[0m €37mâ €mmmmâ €[37mâ € <br />
 E model_Global, ONLY: CONSTRAIN,CFACTOR<br />
<br />
"
h_fract = "DFRACT = mod(((DAYCOUNTER*dt)/86400.) + mod(JDAY,1.),1.)<br />
"</p>
<p>eq1 = "C(ind_$(species))= CFACTOR*(10**($(s_eq)))" eq2 = "CONSTRAIN(ind_$(species)) = C(ind_$(species))"</p>
<p>println(use * h_fract * "\n" *eq1 * "\n" * eq2) ``` </p><pre class="fragment">USE model_Global,       ONLY: CONSTRAIN,CFACTOR

DFRACT = mod(((DAYCOUNTER*dt)/86400.) + mod(JDAY,1.),1.)

C(ind_HO2)= CFACTOR*(10**(-9.0969 - 19.0438*DFRACT &amp;
    + 481.4511*DFRACT**2 - 4471.6722*DFRACT**3 &amp;
    + 20929.2956*DFRACT**4 - 55026.7687*DFRACT**5 &amp;
    + 85141.4376*DFRACT**6 - 77002.8386*DFRACT**7 &amp;
    + 37641.4880*DFRACT**8 - 7673.2978*DFRACT**9))
CONSTRAIN(ind_HO2) = C(ind_HO2)
</pre><h2>Results:</h2>
<p>Below are the results as a proof of concept. If you just want to vary temp, You may import the variable using </p><pre class="fragment">        USE model_Global,       ONLY: CONSTRAIN,CFACTOR,TEMP
</pre><p>replace C(ind_HO2) with TEMP and ommit the line CONSTRAIN(ind_HO2) = C(ind_HO2).</p>
<h4>Pre constraing - HO2 is used up over time</h4>
<div class="image">
<img src="./img/ho2free.png" alt="alt text"/>
</div>
<h4>After constraining all peaks are identical and match our "observed"</h4>
<p>values </p><div class="image">
<img src="./img/ho2obs.png" alt="alt text"/>
</div>
 </div></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.14
</small></address>
</body>
</html>
